name: Sync Config to Branches

on:
  push:
    branches:
      - main
    paths:
      - 'config.yaml'
      - 'docker-compose.yaml'
      - 'Dockerfile'

jobs:
  sync-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq
        uses: mikefarah/yq@v4.52.2

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect changed files
        id: changes
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "config.yaml docker-compose.yaml Dockerfile")
          echo "files: $CHANGED"
          
          echo "dockerfile=$(echo "$CHANGED" | grep -q 'Dockerfile' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "compose=$(echo "$CHANGED" | grep -q 'docker-compose.yaml' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "config=$(echo "$CHANGED" | grep -q 'config.yaml' && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Sync to all branches
        run: |
          set -e

          SYNC_DOCKERFILE="${{ steps.changes.outputs.dockerfile }}"
          SYNC_COMPOSE="${{ steps.changes.outputs.compose }}"
          SYNC_CONFIG="${{ steps.changes.outputs.config }}"

          # Early exit if nothing to sync
          if [ "$SYNC_DOCKERFILE" = "false" ] && [ "$SYNC_COMPOSE" = "false" ] && [ "$SYNC_CONFIG" = "false" ]; then
            echo "No relevant changes, skipping"
            exit 0
          fi

          # Save template files from main
          git checkout main && git pull origin main
          [ "$SYNC_DOCKERFILE" = "true" ] && cp Dockerfile /tmp/main_Dockerfile
          [ "$SYNC_COMPOSE" = "true" ] && cp docker-compose.yaml /tmp/main_docker_compose.yaml

          IP=$(yq '.ip' config.yaml | tr -d '"')
          CORES=$(yq '.runner | keys | .[]' config.yaml)

          update_branch() {
            local BRANCH=$1 CPU=$2 MEMORY=$3 WORKERS=$4

            echo "Processing: $BRANCH (CPU: $CPU, Mem: $MEMORY, Workers: $WORKERS)"

            # Checkout or create branch
            if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
              git branch -D "$BRANCH" 2>/dev/null || true
              git fetch origin "$BRANCH"
              git checkout -b "$BRANCH" "origin/$BRANCH"
            else
              git checkout main
              git checkout -b "$BRANCH"
            fi

            # Sync files
            [ "$SYNC_DOCKERFILE" = "true" ] && [ -f /tmp/main_Dockerfile ] && cp /tmp/main_Dockerfile Dockerfile
            [ "$SYNC_COMPOSE" = "true" ] && [ -f /tmp/main_docker_compose.yaml ] && cp /tmp/main_docker_compose.yaml docker-compose.yaml

            # Update config values (always apply to ensure consistency)
            sed -i "s|cpus: \"[^\"]*\"|cpus: \"$CPU\"|" docker-compose.yaml
            sed -i "s|memory: [^ ]*|memory: $MEMORY|" docker-compose.yaml
            sed -i "s|command: \[\"[^\"]*\", \"[^\"]*\"\]|command: [\"$IP\", \"$WORKERS\"]|" docker-compose.yaml

            # Commit and push only if changed
            git add Dockerfile docker-compose.yaml
            if ! git diff --cached --quiet; then
              git commit -m "chore: Sync (CPU: $CPU, Mem: $MEMORY, Workers: $WORKERS)"
              git push origin "$BRANCH"
              echo "  ✓ Pushed"
            else
              echo "  No changes"
            fi

            git checkout main
          }

          # Phase 1: Normal branches
          echo "=== Phase 1: Normal branches ==="
          for CORE in $CORES; do
            CPU=$(yq ".runner.$CORE.hw.cpu" config.yaml)
            MEMORY=$(yq ".runner.$CORE.hw.memory" config.yaml | tr -d '"')
            WORKERS=$(yq ".runner.$CORE.workers.normal" config.yaml)
            update_branch "$CORE" "$CPU" "$MEMORY" "$WORKERS"
          done

          # Phase 2: Derived branches
          echo "=== Phase 2: Derived branches ==="
          for CORE in $CORES; do
            CPU=$(yq ".runner.$CORE.hw.cpu" config.yaml)
            MEMORY=$(yq ".runner.$CORE.hw.memory" config.yaml | tr -d '"')
            
            for CLASS in $(yq ".runner.$CORE.workers | keys | .[]" config.yaml); do
              [ "$CLASS" = "normal" ] && continue
              WORKERS=$(yq ".runner.$CORE.workers.$CLASS" config.yaml)
              update_branch "$CORE-$CLASS" "$CPU" "$MEMORY" "$WORKERS"
            done
          done

          echo "✓ Done"
